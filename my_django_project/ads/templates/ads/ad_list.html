<!-- ads/templates/ads/ad_list.html -->
{% extends 'ads/base.html' %}
{% load static %}
{% load my_filters %}

{% block title %}Все объявления{% endblock %}

{% block styles %}
    {{ block.super }}  {# чтобы подключить стили из base.html #}
{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 700px;">
    <h1 class="mb-4">Все объявления</h1>

    <!-- Навигация и действия -->
    <div class="mb-3">
        {% if user.is_authenticated %}
            <a href="{% url 'ad_create' %}" class="btn btn-success me-2">Создать новое объявление</a>
            <a href="{% url 'my_ads' %}" class="btn btn-info">Мои объявления</a>
            <!-- Здесь добавьте ссылку на смену пароля -->
            <a href="{% url 'password_change' %}" class="btn btn-secondary">Сменить пароль</a>
        {% else %}
            <a href="{% url 'login' %}" class="btn btn-primary">Войти</a>
        {% endif %}
    </div>


    <!-- Форма поиска -->
    <form method="get" class="input-group mb-3">
        <input type="text" name="q" class="form-control" placeholder="Поиск объявлений" value="{{ request.GET.q|default_if_none:'' }}">
        <button class="btn btn-outline-primary" type="submit">Поиск</button>
    </form>

    <!-- Список объявлений -->
    <ul class="list-group" id="ad-list">
        {% for ad in ads %}
            {% include 'ads/_ad_items.html' %}
        {% empty %}
            <li class="list-group-item">Объявлений нет.</li>
        {% endfor %}
    </ul>

    <!-- Категории в нижней части -->
    <div class="mt-5">
        <h5>Категории</h5>
        {% if categories %}
            <div class="d-flex flex-wrap gap-2">
                {% for category in categories %}
                    {% if category.slug %}
                        <a href="{% url 'ads_by_category' slug=category.slug %}" class="btn btn-outline-primary btn-sm">{{ category.name }}</a>
                    {% else %}
                        <span class="btn btn-outline-secondary btn-sm disabled" title="Slug отсутствует">{{ category.name }}</span>
                    {% endif %}
                {% endfor %}
            </div>
        {% else %}
            <p>Категории не найдены.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Скрипт для обработки кликов по кнопкам избранного -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrfToken = getCookie('csrftoken');

    document.querySelectorAll('.toggle-bookmark').forEach(button => {
        button.addEventListener('click', () => {
            button.disabled = true;
            const adItem = button.closest('li[data-ad-slug]');
            const adSlug = adItem ? adItem.getAttribute('data-ad-slug') : null;
            if (!adSlug) {
                alert('Ошибка: у объявления отсутствует slug.');
                button.disabled = false;
                return;
            }

            fetch('/ads/toggle-bookmark/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({'ad_slug': adSlug})
            })
            .then(response => {
                if (!response.ok) throw new Error('Ошибка сети');
                return response.json();
            })
            .then(data => {
                if (data.status === 'added') {
                    button.textContent = 'Убрать из избранного';
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-warning');
                } else if (data.status === 'removed') {
                    button.textContent = 'В избранное';
                    button.classList.remove('btn-warning');
                    button.classList.add('btn-outline-primary');
                } else if (data.error) {
                    alert(data.error);
                }
            })
            .catch(() => {
                alert('Ошибка при добавлении в избранное.');
            })
            .finally(() => {
                button.disabled = false;
            });
        });
    });
});
</script>

<!-- Блок сообщений -->
{% if messages %}
    <div class="mt-3">
        {% for message in messages %}
            {% if message.level_tag == 'error' %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                </div>
            {% else %}
                <div class="alert alert-{{ message.level_tag }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                </div>
            {% endif %}
        {% endfor %}
    </div>
{% endif %}
</body>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Передача переменных из Django-шаблона в JavaScript
    const initialPage = {{ page_obj.number|default:"1" }};
    const totalPagesCount = {{ page_obj.paginator.num_pages|default:"1" }};

    // Инициализация текущей страницы и общего количества страниц
    let page = initialPage;
    const totalPages = totalPagesCount;

    let loading = false; // чтобы избежать параллельных запросов

    const adList = document.getElementById('ad-list');

    // Функция получения CSRF-токена
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrfToken = getCookie('csrftoken');

    // Функция для повторной инициализации кнопок "Избранное"
    function initBookmarkButtons(root = document) {
        root.querySelectorAll('.toggle-bookmark').forEach(button => {
            button.removeEventListener('click', bookmarkHandler);
            button.addEventListener('click', bookmarkHandler);
        });
    }

    function bookmarkHandler(e) {
        const button = e.currentTarget;
        button.disabled = true;

        const adItem = button.closest('li[data-ad-slug]');
        const adSlug = adItem ? adItem.getAttribute('data-ad-slug') : null;
        if (!adSlug) {
            alert('Ошибка: у объявления отсутствует slug.');
            button.disabled = false;
            return;
        }

        fetch('/ads/toggle-bookmark/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({ 'ad_slug': adSlug })
        })
        .then(response => {
            if (!response.ok) throw new Error('Ошибка сети');
            return response.json();
        })
        .then(data => {
            if (data.status === 'added') {
                button.textContent = 'Убрать из избранного';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-warning');
            } else if (data.status === 'removed') {
                button.textContent = 'В избранное';
                button.classList.remove('btn-warning');
                button.classList.add('btn-outline-primary');
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(() => {
            alert('Ошибка при добавлении в избранное.');
        })
        .finally(() => {
            button.disabled = false;
        });
    }

    initBookmarkButtons();

    // Загрузка следующей страницы
    function loadNextPage() {
        if (loading || page >= totalPages) return;

        loading = true;
        page += 1;

        const params = new URLSearchParams(window.location.search);
        params.set('page', page);

        fetch(window.location.pathname + '?' + params.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Ошибка загрузки');
            return response.text();
        })
        .then(html => {
            // Возвращается HTML с <li> элементами
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            const newItems = tempDiv.querySelectorAll('li.list-group-item');

            if (newItems.length === 0) {
                // Больше объявлений нет — останавливаем
                page = totalPages;
            } else {
                newItems.forEach(item => adList.appendChild(item));
                // Инициализируем кнопки новых элементов
                initBookmarkButtons(adList);
            }
            loading = false;
        })
        .catch(err => {
            console.error(err);
            loading = false;
        });
    }

    // Обработчик прокрутки
    window.addEventListener('scroll', () => {
        if (loading || page >= totalPages) return;
        const scrollPosition = window.innerHeight + window.scrollY;
        const threshold = document.body.offsetHeight - 200;

        if (scrollPosition >= threshold) {
            loadNextPage();
        }
    });

    // Обработка форм отзывов
    document.querySelectorAll('form[id^="review-form-"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const slug = form.dataset.adsSlug;
            const formData = new FormData(form);

            fetch(`/ads/${slug}/add_review/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем блок отзывов
                    const reviewsContainer = document.querySelector(`#reviews-container-${slug}`);
                    if (reviewsContainer) {
                        reviewsContainer.innerHTML = data.reviews_html;  // Предполагается, что сервер возвращает готовый HTML
                    }
                    form.reset(); // очистка формы
                } else {
                    alert('Ошибка при отправке отзыва');
                }
            })
            .catch(() => {
                alert('Произошла ошибка при отправке.');
            });
        });
    });
});
</script>
</html>