<!-- ads/templates/ads/_ad_items.html -->
{% load my_filters %}
{% load static %}

{% for ad in ads %}
<li class="list-group-item" data-ad-id="{{ ad.id }}" data-ad-slug="{{ ad.slug }}">
  <div class="d-flex flex-column">
    <!-- Основная информация об объявлении -->
    <div class="d-flex justify-content-between align-items-center mb-1">
      {% if ad.slug %}
        <a href="{% url 'ad_detail' slug=ad.slug %}">{{ ad.title }}</a>
      {% else %}
        {{ ad.title }} <small class="text-danger">(нет ссылки: отсутствует slug)</small>
      {% endif %}
      <small class="text-muted">by {{ ad.author.username }}</small>
    </div>
    <div class="mb-1">
      <small class="text-muted">Опубликовано: {{ ad.created_at|local_time:"%d.%m.%Y %H:%M" }}</small>
    </div>
    <div class="mb-2">
      {% if ad.tags.all|length > 0 %}
        {% for tag in ad.tags.all %}
          <a href="{% url 'ads_by_tag' slug=tag.slug %}" class="badge bg-secondary text-decoration-none me-1">{{ tag.name }}</a>
        {% endfor %}
      {% else %}
        <small class="text-muted">Без тегов</small>
      {% endif %}
    </div>
    {% if user.is_authenticated %}
    <!-- Кнопка избранного -->
    <div>
      <button class="btn btn-sm {% if ad.id in user_favorites %}btn-warning{% else %}btn-outline-primary{% endif %} toggle-bookmark"
        data-ad-id="{{ ad.id }}"
        data-ad-slug="{{ ad.slug }}"
        data-ajax-url="{% url 'toggle-bookmark-slug' slug=ad.slug %}">
        {% if ad.id in user_favorites %}Убрать из избранного{% else %}В избранное{% endif %}
      </button>
    </div>
    {% endif %}
  </div>

  <!-- Блок отзывов -->
  <div id="reviews-container-{{ ad.slug }}" class="mt-3">
    {% include 'ads/reviews_list.html' with reviews=ad.reviews.all %}
  </div>

  <!-- Форма отправки отзыва -->
  <form id="review-form-{{ ad.slug }}" data-ads-slug="{{ ad.slug }}" class="review-form mt-2">
    {% csrf_token %}
    {{ review_form.as_p }}
    <button type="submit" class="btn btn-sm btn-primary">Отправить отзыв</button>
    <div class="review-error text-danger mt-2" style="display:none;"></div>
  </form>
</li>
{% empty %}
<li class="list-group-item">Объявлений нет.</li>
{% endfor %}

{% block custom_js %}
<script>
// =================== Обработка кнопки "Избранное" ===================
document.querySelectorAll('.toggle-bookmark').forEach(btn => {
    btn.addEventListener('click', async function (e) {
        e.preventDefault();
        if (btn.disabled) return; // уже отключена
        btn.disabled = true;

        const adSlug = btn.dataset.adSlug;
        const url = btn.dataset.ajaxUrl;  // здесь читается правильно сформированный URL

        if (!adSlug || !url) {
            console.error('Не найден slug или url объявления');
            btn.disabled = false;
            return;
        }

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ ad_slug: adSlug }),
            });
            if (!response.ok) {
                const errText = await response.text();
                console.error('Ошибка сервера:', errText);
                alert('Ошибка при обновлении в избранное.');
            } else {
                const data = await response.json();
                // Обновление состояния кнопки
                if (data.is_favorited) {
                    btn.textContent = 'Убрать из избранного';
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-warning');
                } else {
                    btn.textContent = 'В избранное';
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-outline-primary');
                }
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при обновлении избранного.');
        } finally {
            btn.disabled = false;
        }
    });
});

// Функция получения CSRF-токена из cookie
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i=0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// =================== Обработка отправки отзывов ===================
document.querySelectorAll('form[id^="review-form-"]').forEach(form => {
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const slug = form.dataset.adsSlug;
        const textarea = form.querySelector('textarea[name="text"]');

        // Проверка обязательного поля
        if (!textarea || !textarea.value.trim()) {
            const errorDiv = form.querySelector('.review-error');
            if (errorDiv) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Пожалуйста, заполните поле текста отзыва.';
            }
            return;
        }

        const formData = new FormData(form);
        const url = `/ads/${slug}/add_review/`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData,
            });
            if (!response.ok) {
                alert('Ошибка при отправке. Статус: ' + response.status);
                return;
            }
            const data = await response.json();

            if (data.success) {
                // Обновляем блок отзывов
                const reviewsContainer = document.querySelector(`#reviews-container-${slug}`);
                if (reviewsContainer) {
                    reviewsContainer.innerHTML = data.reviews_html;
                }
                form.reset();
                // Скрываем сообщение об ошибке
                const errorDiv = form.querySelector('.review-error');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                    errorDiv.textContent = '';
                }
            } else {
                const errorDiv = form.querySelector('.review-error');
                if (errorDiv) {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = data.errors || 'Произошла ошибка.';
                }
            }
        } catch (err) {
            console.error('Ошибка fetch:', err);
            alert('Произошла ошибка при отправке отзыва.');
        }
    });
});
</script>
{% endblock %}
